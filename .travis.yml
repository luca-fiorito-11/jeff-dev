language: python

env:
  global:
    - CACHEDIR=~/mycache
    - UTILS=${CACHEDIR}/PVBV_utils
    - ACEDIR=${CACHEDIR}/ace
    - H5DIR=${CACHEDIR}/h5
    - FC='gfortran-5'
    - PYTHONPATH="${UTILS}/openmc:$PYTHONPATH"
    - OPENMC_CROSS_SECTIONS=${H5DIR}/cross_sections.xml

python:
  - "3.6"

cache:
  directories:
    - ${CACHEDIR}

stages:
  - setup
  - ace
  - hdf5
  - run

jobs:
  include:

    - stage: setup
      name: setup cache directory
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - gfortran-5
            - gcc-5
            - g++-5
            - cmake
            - libhdf5-dev
      install:
        - rm -rf ${CACHEDIR}
        - mkdir -p ${CACHEDIR} ${ACEDIR} ${H5DIR}
        - ( cd ${CACHEDIR} && git clone https://github.com/luca-fiorito-11/PVBV_utils.git )
        - ( cd ${CACHEDIR} && git clone https://github.com/luca-fiorito-11/benchmarks.git )
        - ( cd ${UTILS} && ./install_openmc.sh )
        - mkdir -p ${UTILS}/openmc/build && cd ${UTILS}/openmc/build
        - h5cc -showconfig
        #- "export HDF5_ROOT=$(h5cc -showconfig | grep \"Installation point\" | cut -d: -f2 | xargs)"
        - export LD_LIBRARY_PATH=/usr
        - export HDF5_ROOT=/usr
        - cmake -DCMAKE_CXX_COMPILER=$(which g++-5) ..
        - make
      script: skip


    - stage: ace
      name: get ACE files
      script:
        - curl -o ${ACEDIR}/31-Ga-69g.jeff33.ace https://github.com/luca-fiorito-11/31-Ga-69g/releases/download/v4.0T0/31-Ga-69g.jeff33.ace -k -L
        - curl -o ${ACEDIR}/31-Ga-79g.jeff33.ace https://github.com/luca-fiorito-11/31-Ga-71g/releases/download/v4.0T0/31-Ga-71g.jeff33.ace -k -L
        - curl -o ${ACEDIR}/94-Pu-239g.jeff33.ace https://github.com/luca-fiorito-11/94-Pu-239g/releases/download/v4.0T0/94-Pu-239g.jeff33.ace -k -L
        - curl -o ${ACEDIR}/94-Pu-240g.jeff33.ace https://github.com/luca-fiorito-11/94-Pu-240g/releases/download/v4.0T0/94-Pu-240g.jeff33.ace -k -L
        - curl -o ${ACEDIR}/94-Pu-241g.jeff33.ace https://github.com/luca-fiorito-11/94-Pu-241g/releases/download/v4.0T0/94-Pu-241g.jeff33.ace -k -L

    - stage: hdf5
      name: h5
      install:
        - pip install pandas h5py scipy uncertainties
      script:
        - python ${UTILS}/add_ace_openmc.py ${ACEDIR} -d ${H5DIR}

    - stage: run
      name: pmf1
      addons:
        apt:
          sources:
            - ubuntu-toolchain-r-test
          packages:
            - libhdf5-dev      
      script:
        - h5cc -showconfig
        - export LD_LIBRARY_PATH=/usr
        - export HDF5_ROOT=/usr
        - ( cd ${CACHEDIR}/benchmarks/icsbep/pu-met-fast-001/openmc && ${UTILS}/openmc/build/bin/openmc )
